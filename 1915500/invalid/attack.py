""" 
Sketch of the attack

1. The elliptic curve is E: y^2 = x^3 + a_4x + a_6 for known a_4 and a_6
2. We choose E' s.t. we can select a point P on E' with ord(P) = r for a small r
3. Since multiplication does not depend on a_6, if we input P to device D, we get [k]P on E' as output
4. Therefore our problem becomes given P, [k]P on E', find k mod ord(P)
5. We repeat with different choices of P and use CRT to compute k
"""

"""
Sagemath stages:

https://crypto.stackexchange.com/questions/71065/invalid-curve-attack-finding-low-order-points

E = EllipticCurve(F, [Mod(-3, p), b]
n = E.order()
n.factor()

P = E.random_point()
o = P.order()
o.factor()


You can then take these factors and compute P.__mul__(o // factor) which will have the order of the factor
Have now found a point on the invalid elliptic curve with the order

May need to use several of these curves with several factors
Need to find a set of prime factors larger than 2 ** 256

"""

import sys
import subprocess
from typing import NamedTuple

class Point(NamedTuple):
    a_6: int
    order: int
    x: int
    y: int

POINTS = (
    Point(
        a_6 = 1,
        order = 71,
        x = 28259279395972023776513774105241928246962498203283306978725161059915300516812,
        y = 63209961896593677827159582592311321908483099424656281348075589839784323824847
    ),
    Point(
        a_6 = 1,
        order = 823,
        x = 87713185297228976821304890513941862211693061851535545840693819255454361634048,
        y = 112693079826111214039277966073432377400336220628474151196801500581911598124509
    ),
    Point(
        a_6 = 1,
        order = 1229,
        x = 206883884147126945808549336763852493698012431899018050348556697572236602683,
        y = 20608134931947835620991899010681971494154276791145956869592094752965415335247
    ),
    Point(
        a_6 = 1,
        order = 7489,
        x = 69881283504569799488602239712833087975425166784596071774520794672185507702440,
        y = 42478926601988875279028976856574013051927848516429690233932858856224934471364
    ),
    Point(
        a_6 = 1,
        order = 30203,
        x = 25775413810489730027531476036637049728872382788445394870248456751344290946088,
        y = 48098706110172973464517362651969722623725248533356877915476596697642760088579
    ),
    Point(
        a_6 = 3,
        order = 2,
        x = 104678110497112089739021755190598720911144497118944825291883337410031374501651,
        y = 0
    ),
    Point(
        a_6 = 3,
        order = 3,
        x = 89995002874197087156160429731648695860910221822426040658975619972952380673767,
        y = 14349743460558275675129535079038365302062743301233311020938192075259646708873
    ),
    Point(
        a_6 = 3,
        order = 7,
        x = 89160674440956328538893206540265823545209810924936759489615962285452747599555,
        y = 52836242829875876292581891125276081784043606482480767427606671740391240450713
    ),
    Point(
        a_6 = 3,
        order = 37,
        x = 71381269501775968128475011265598269069347980821218846743948246753286064412420,
        y = 93106089722491605224338586731271529062359787069042949543385151555752345954179
    ),
    Point(
        a_6 = 3,
        order = 97,
        x = 30904076697445238773861874582065136691682689019361035376155684137084335642348,
        y = 44581633413506981437332018259337199045876739282554009841521896356257539543530
    ),
    Point(
        a_6 = 3,
        order = 113, 
        x = 37740878285059773035328689737568253192782053795734741220535442668741782227005,
        y = 97859746809226442457938140864810156199654698584313597023826244066108044386181
    ),
    Point(
        a_6 = 4,
        order = 13,
        x = 104136813632778771640723729751464035108143385005433100064043059550777778556984,
        y = 15014177230142224843904041558393363953733994483644983931314086007831689563066
    ),
    Point(
        a_6 = 4,
        order = 19,
        x = 36221710188095645195916735943504126562048718788327839336905432475771375088876,
        y = 65733430588181762227151762173430151752013131127102040334492994886275821618878
    ),
    Point(
        a_6 = 4,
        order = 179,
        x = 19266681284548760829403297706358392755309516987335583377397055619851330063169,
        y = 115492014883061975461992340482394619395522701733330184126317566082592026221943,
    ),
    Point(
        a_6 = 4,
        order = 13003,
        x = 108725273062108112757164265968313783127328954942354440318545455442753789970128,
        y = 56626446366152483510283860071227638814991915877593437448427667291770046867350
    ),
    Point(
        a_6 = 5,
        order = 2447,
        x = 51896770152511673981968622706299486704194470668181753013246919989382842739910,
        y = 44974617826304704518136705750109983576513297829925574154480434246772498479217
    ),
    Point(
        a_6 = 8,
        order = 5,
        x = 98978311886854243013463161515763200390415842892933331112552629473421888994121,
        y = 80552728618039432368576332813506254169831345235585557049987118264806353660326
    ),
    Point(
        a_6 = 9,
        order = 653,
        x = 80399323733805371647278874455416495727665351687995874532963703346580557182215,
        y = 64221097626823962777722972078298176284771360698147733241577406594190323253525
    ),
    Point(
        a_6 = 11,
        order = 19423,
        x = 37795557974970371519487312148887192918305960495147418096832791872247505882621,
        y = 61147296591064249257955580639646489274401929545998690686781250270375381534956
    ),
    Point(
        a_6 = 12,
        order = 389,
        x = 31595831993368958708756390443130025217175750116889125802216877195369387670538,
        y = 113685024074464209570625491562318497579116301699584020533141320468987813018840
    ),
    Point(
        a_6 = 12,
        order = 52183,
        x = 86777023071443973650759726219306030059744689148080908618061955376713540425038,
        y = 43280915548009789573678997069200513419682698710705700055526224897913252818446
    ),
    Point(
        a_6 = 14,
        order = 17,
        x = 3413459363395996421077657095954449129535482526656543541251186863502954511992,
        y = 1838520503069831081084618017350900277772667650158943821878116964019848605801
    ),
    Point(
        a_6 = 14,
        order = 491,
        x = 14966144267389723782847602649653032427348427111610616793571707357613487810271,
        y = 114698845801755732114560608350539734785738135357056479089679715896226602077503
    ),
    Point(
        a_6 = 14,
        order = 3109,
        x = 62269680450948285639937835043830165400537068952885818358499615616184336196576,
        y = 76238607702193277407378511998289866107205926593740377936268095875301661875169
    ),
    Point(
        a_6 = 15,
        order = 421,
        x = 38484100367918503545168415316162136609686705856689256383154622999120828068216,
        y = 37444630015825408056828258447618085016729225264145246434409494530974797740154
    ),
    Point(
        a_6 = 15,
        order = 1871,
        x = 27152844424558016935261366635707450150700642167415093024797045732139176489740,
        y = 6550820316963708270980766282148480279221063353875581691130317914051327688378
    ),
    Point(
        a_6 = 19,
        order = 11,
        x = 11558178732251576330294510069979547887342244276702047654030051460396058662497,
        y = 87254271143199490539665399634971558884490527915076501909711209983947132853337
    ),
    Point(
        a_6 = 19,
        order = 829,
        x = 9514346497383556222579619158341776674131364064273695483727358392426157182957,
        y = 23495205416855217052557520192504178663030120373308667027919135702875839853362
    ),
    Point(
        a_6 = 20,
        order = 79,
        x = 12429657496764110525959663766544070467746376152800768399443398493342181975854,
        y = 69057829560526670847162725836848206568571225594049174692515881748726964004733
    ),
    Point(
        a_6 = 21,
        order = 433,
        x = 57918052159968238616619540218021789167037255883234912121083241916392144331885,
        y = 95646629799794040007199549490698192209142383259456190804730628440879012419866
    ),
    Point(
        a_6 = 21,
        order = 33493, 
        x = 65774881983761717312270456499009503411729572183359173173249925597483488542474,
        y = 6567335573532975085815797319308921109552197043248793123121966089262835731514
    ),
    Point(
        a_6 = 31,
        order = 109,
        x = 56640544195937444035716179134321246089995386945079699305865570199904911353153,
        y = 7127871820181015976774868561218996588707527000691958085027891777694816487935
    )
)

TARGET = subprocess.Popen(
    args = f"./{sys.argv[1]}",
    stdin = subprocess.PIPE,
    stdout = subprocess.PIPE
)
TARGET_IN = TARGET.stdin
TARGET_OUT = TARGET.stdout

def interact(p_x, p_y):
    TARGET_IN.write(f"{p_x:x}\n".encode())
    TARGET_IN.write(f"{p_y:x}\n".encode())
    TARGET_IN.flush()
    q_x = int(TARGET_OUT.readline().strip(), 16)
    q_y = int(TARGET_OUT.readline().strip(), 16)
    return q_x, q_y

def attack():
    for point in POINTS:
        q_x, q_y = interact(point.x, point.y)
        print(point.order, q_x, q_y)

if __name__ == "__main__":
    attack()