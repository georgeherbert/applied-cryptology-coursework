import sys
import subprocess
from typing import NamedTuple

class Point(NamedTuple):
    x: int
    y: int

ORDERS = (71, 823, 1229, 7489, 30203, 2, 7, 37, 97, 113, 13, 19, 179, 13003, 2447, 653, 19423, 389, 52183, 17, 491, 3109, 421, 1871, 11, 829, 79, 433, 33493, 109, 7103, 439, 2341, 131, 673, 2473, 9719, 349, 229, 1373, 40169, 449, 59, 73, 47, 1579, 8123, 31, 2659, 607, 4003, 61, 1867, 49597, 1019, 5387)
A_6 = (1, 1, 1, 1, 1, 3, 3, 3, 3, 3, 4, 4, 4, 4, 5, 9, 11, 12, 12, 14, 14, 14, 15, 15, 19, 19, 20, 21, 21, 31, 31, 33, 33, 36, 36, 39, 39, 40, 42, 42, 44, 46, 48, 48, 49, 49, 50, 52, 54, 61, 61, 62, 62, 66, 67, 70)

POINTS = (
    Point(x = 28259279395972023776513774105241928246962498203283306978725161059915300516812, y = 63209961896593677827159582592311321908483099424656281348075589839784323824847),
    Point(x = 87713185297228976821304890513941862211693061851535545840693819255454361634048, y = 112693079826111214039277966073432377400336220628474151196801500581911598124509),
    Point(x = 206883884147126945808549336763852493698012431899018050348556697572236602683, y = 20608134931947835620991899010681971494154276791145956869592094752965415335247),
    Point(x = 69881283504569799488602239712833087975425166784596071774520794672185507702440, y = 42478926601988875279028976856574013051927848516429690233932858856224934471364),
    Point(x = 25775413810489730027531476036637049728872382788445394870248456751344290946088, y = 48098706110172973464517362651969722623725248533356877915476596697642760088579),
    Point(x = 104678110497112089739021755190598720911144497118944825291883337410031374501651, y = 0),
    Point(x = 89160674440956328538893206540265823545209810924936759489615962285452747599555, y = 52836242829875876292581891125276081784043606482480767427606671740391240450713),
    Point(x = 71381269501775968128475011265598269069347980821218846743948246753286064412420, y = 93106089722491605224338586731271529062359787069042949543385151555752345954179),
    Point(x = 30904076697445238773861874582065136691682689019361035376155684137084335642348, y = 44581633413506981437332018259337199045876739282554009841521896356257539543530),
    Point(x = 37740878285059773035328689737568253192782053795734741220535442668741782227005, y = 97859746809226442457938140864810156199654698584313597023826244066108044386181),
    Point(x = 104136813632778771640723729751464035108143385005433100064043059550777778556984, y = 15014177230142224843904041558393363953733994483644983931314086007831689563066),
    Point(x = 36221710188095645195916735943504126562048718788327839336905432475771375088876, y = 65733430588181762227151762173430151752013131127102040334492994886275821618878),
    Point(x = 19266681284548760829403297706358392755309516987335583377397055619851330063169, y = 115492014883061975461992340482394619395522701733330184126317566082592026221943,),
    Point(x = 108725273062108112757164265968313783127328954942354440318545455442753789970128, y = 56626446366152483510283860071227638814991915877593437448427667291770046867350),
    Point(x = 51896770152511673981968622706299486704194470668181753013246919989382842739910, y = 44974617826304704518136705750109983576513297829925574154480434246772498479217),
    Point(x = 80399323733805371647278874455416495727665351687995874532963703346580557182215, y = 64221097626823962777722972078298176284771360698147733241577406594190323253525),
    Point(x = 37795557974970371519487312148887192918305960495147418096832791872247505882621, y = 61147296591064249257955580639646489274401929545998690686781250270375381534956),
    Point(x = 31595831993368958708756390443130025217175750116889125802216877195369387670538, y = 113685024074464209570625491562318497579116301699584020533141320468987813018840),
    Point(x = 86777023071443973650759726219306030059744689148080908618061955376713540425038, y = 43280915548009789573678997069200513419682698710705700055526224897913252818446),
    Point(x = 3413459363395996421077657095954449129535482526656543541251186863502954511992, y = 1838520503069831081084618017350900277772667650158943821878116964019848605801),
    Point(x = 14966144267389723782847602649653032427348427111610616793571707357613487810271, y = 114698845801755732114560608350539734785738135357056479089679715896226602077503),
    Point(x = 62269680450948285639937835043830165400537068952885818358499615616184336196576, y = 76238607702193277407378511998289866107205926593740377936268095875301661875169),
    Point(x = 38484100367918503545168415316162136609686705856689256383154622999120828068216, y = 37444630015825408056828258447618085016729225264145246434409494530974797740154),
    Point(x = 27152844424558016935261366635707450150700642167415093024797045732139176489740, y = 6550820316963708270980766282148480279221063353875581691130317914051327688378),
    Point(x = 11558178732251576330294510069979547887342244276702047654030051460396058662497, y = 87254271143199490539665399634971558884490527915076501909711209983947132853337),
    Point(x = 9514346497383556222579619158341776674131364064273695483727358392426157182957, y = 23495205416855217052557520192504178663030120373308667027919135702875839853362),
    Point(x = 12429657496764110525959663766544070467746376152800768399443398493342181975854, y = 69057829560526670847162725836848206568571225594049174692515881748726964004733),
    Point(x = 57918052159968238616619540218021789167037255883234912121083241916392144331885, y = 95646629799794040007199549490698192209142383259456190804730628440879012419866),
    Point(x = 65774881983761717312270456499009503411729572183359173173249925597483488542474, y = 6567335573532975085815797319308921109552197043248793123121966089262835731514),
    Point(x = 56640544195937444035716179134321246089995386945079699305865570199904911353153, y = 7127871820181015976774868561218996588707527000691958085027891777694816487935),
    Point(x = 114478979147039371114757454159184408364550736658297615439777362484515217378996, y = 40706974332247832662962637854620584522597024847435929774538312959890136346180),
    Point(x = 45236375731980838384708777856117825326208567790512075389743893039456417046789, y = 66869404498886028212570476567087765983673963126718071709414865704071173340310),
    Point(x = 82842327826922627380780125680708202131601933000827345113683718307637265277572, y = 106057195468941660838338129388774945902021274298369675276265816364842506064011),
    Point(x = 62649556530269196374231219733504197101362833037237431123508083468348196209569, y = 56072938607500302600356056496116185493916452958743688847820379779198298973504),
    Point(x = 54106689002855714160260697291342690504819711080466227310062599079248225039243, y = 51409669475836465862573970907596273303407533157801814523688108418459478701230),
    Point(x = 66073797683304679417667691212935185320538365482079408635817239012409995092923, y = 75469137334836900112404889116548219362689381013229884628746616324707084763833),
    Point(x = 107479559353094356240185868941494731270545981617575543057669924051052738284946, y = 5053535302272579529892886307877652761565257832805103735722766720968017280618),
    Point(x = 22875956984718106148501378873082845515974032381625665763247246412416716849543, y = 82747000226249230260938204288413325412608915799429555960378802450307589740638),
    Point(x = 101741935224361460818736481701364602153143423360261538046986862667710961317064, y = 51166816763883626239516605216340933938215591492359628940860736169918943807016),
    Point(x = 81243841971761400417520053751454753952646603900894010386511265402835565126956, y = 71916324325448558471871531800648096257229970008419525372690167245166719704673),
    Point(x = 14530069933754903044065080678080909292421892643197985993724529598946710247884, y = 104967125356983797731729931162496772592968446192098666170922041523261942437949),
    Point(x = 109365146173285488961422160657100024298400133975584332652289706557320455640695, y = 1681362622036232171551955708886567920954331999837914822941411063159049945286),
    Point(x = 60113342969066112042728868630551622159382497455324446140472695565125439596476, y = 113835658428893081236046863686582559469215336749105783467952435889581050817175),
    Point(x = 14534927461442511841092204729595321244867670049984851301893759908352609392202, y = 111672596123872250255070651240754430001908171298430151412072785978280608663781),
    Point(x = 73739620478539798645692379438172195564505382932777326557855976777314934012534, y = 8136534632098467553867008588333282245623879581627291613546269869920100743493),
    Point(x = 66480192396435807908450506164891875571424233689385633091814694996877308359083, y = 106477623710624342085495906746533578010419741196915798938814730985636384997264),
    Point(x = 114261429633200676984754066987659989424575407457895825332943954091332137942439, y = 99784514485859767620619258798465892679169539345584122872801831405189828370374),
    Point(x = 89849957831485468518188002649090924578272678499930957340265801798498938999535, y = 60128298300142570699040832498705019123085745379319110474116794324409722507617),
    Point(x = 100035202201497059788717356733161857692336124543187879985250419877289006495598, y = 58662639642709808963394100371881745234544327684020323791191706095988441978973),
    Point(x = 3006993746500054270864490793354204820378686851267711452631855113996397637344, y = 19104152074430271166352898484162412225304710915835525716317621541170459916437),
    Point(x = 66675270946268429991402502408882298568497888580573933991459276916417897284987, y = 4653644998626377300101659475260420635808086153104183380445564929137224619508),
    Point(x = 3668295410264019769338410719147355163427046739760489055869254190276501532950, y = 50022563339179962012608233399264439744653107131866157321338881858972798754874),
    Point(x = 82578358241576305469964324979533196033717918953622955882915123361600262953139, y = 93184764761902659966478835239970325091114361438499700002930213279923718723068),
    Point(x = 55030172201210812898824400928176169719946292226811843923643909008776221001870, y = 85462144257959636305735004709717131325050447794097798269232341333942346238235),
    Point(x = 90983947348833835290319902386811656319683906006528590092753141504876934977810, y = 27942637801340794506227589880374426499150846947109720024336890767946122522736),
    Point(x = 16014936581903786455562763973366341013537912920637973157563629192232590278532, y = 66794201377270027931110545910945504492795351393119969238070252259704554927411)
)

A_4 = 115792089210356248762697446949407573530086143415290314195533631308867097853948
P = 115792089210356248762697446949407573530086143415290314195533631308867097853951

O = "Origin"

TARGET = subprocess.Popen(
    args = f"./{sys.argv[1]}",
    stdin = subprocess.PIPE,
    stdout = subprocess.PIPE
)
TARGET_IN = TARGET.stdin
TARGET_OUT = TARGET.stdout

def interact(p_x, p_y):
    TARGET_IN.write(f"{p_x:x}\n".encode())
    TARGET_IN.write(f"{p_y:x}\n".encode())
    TARGET_IN.flush()
    q_x = int(TARGET_OUT.readline().strip(), 16)
    q_y = int(TARGET_OUT.readline().strip(), 16)
    return Point(q_x, q_y)

def inv_mod_p(x):
    return pow(x, P - 2, P)

def ec_inv(p):
    if p == O:
        return p
    return Point(p.x, (-p.y) % P)

def ec_add(p, q):
    if p == O:
        return q
    elif q == O:
        return p
    elif q == ec_inv(p):
        return O
    else:
        if p == q:
            dydx = (3 * p.x ** 2 + A_4) * inv_mod_p(2 * p.y)
        else:
            dydx = (q.y - p.y) * inv_mod_p(q.x - p.x)
        x = (dydx ** 2 - p.x - q.x) % P
        y = (dydx * (p.x - x) - p.y) % P
        return Point(x, y)

# https://www.geeksforgeeks.org/chinese-remainder-theorem-set-2-implementation/
def inv(a, m) :
    m0 = m
    x0 = 0
    x1 = 1
    if (m == 1) :
        return 0
    # Apply extended Euclid Algorithm
    while (a > 1) :
        # q is quotient
        q = a // m
        t = m
        # m is remainder now, process
        # same as euclid's algo
        m = a % m
        a = t
        t = x0
        x0 = x1 - q * x0
        x1 = t
    # Make x1 positive
    if (x1 < 0) :
        x1 = x1 + m0
    return x1

def findMinX(num, rem, k) :
    # Compute product of all numbers
    prod = 1
    for i in range(0, k) :
        prod = prod * num[i]
    # Initialize result
    result = 0
    # Apply above formula
    for i in range(0,k):
        pp = prod // num[i]
        result = result + rem[i] * inv(pp, num[i]) * pp
    return result % prod

def attack():
    remainders = []

    for point_original, a_6 in zip(POINTS, A_6):
    # for point_original in POINTS:
        point_calculated = interact(point_original.x, point_original.y)
        q = Point(point_original.x, point_original.y)
        i = 1
        while q != Point(point_calculated.x, point_calculated.y):
            q = ec_add(point_original, q)
            i += 1
        print(f"EC = EllipticCurve([FF(a256), FF({a_6})]); P = EC({point_original.x, point_original.y}); P.__mul__({i}) == EC({point_calculated.x}, {point_calculated.y})")
        print("x", point_calculated.x)
        print("y", point_calculated.y)
        print("")

        remainders.append(i)

    # print(len(ORDERS), ORDERS)
    # print(len(remainders), remainders)

    for remainder, order in zip(remainders, ORDERS):
        print(f"x = {remainder} mod {order}")
    key = (findMinX(ORDERS, remainders, len(remainders)))
    print(key)
    
    i = 1
    for order in ORDERS:
        i *= order
    print(i)

    key = 17040557390272033052332931968184054041895115295729239191156355555498654559725

if __name__ == "__main__":
    attack()