#include "attack.h"

#define BUFFER_SIZE (80)
#define NUM_POINTS (56)

typedef struct {
    mpz_t x;
    mpz_t y;
} point;

pid_t pid = 0;

int target_raw[2];
int attack_raw[2];

FILE* target_out = NULL;
FILE* target_in = NULL;

int orders[NUM_POINTS] = {71, 823, 1229, 7489, 30203, 2, 7, 37, 97, 113, 13, 19, 179, 13003, 2447, 653, 19423, 389, 52183, 17, 491, 3109, 421, 1871, 11, 829, 79, 433, 33493, 109, 7103, 439, 2341, 131, 673, 2473, 9719, 349, 229, 1373, 40169, 449, 59, 73, 47, 1579, 8123, 31, 2659, 607, 4003, 61, 1867, 49597, 1019, 5387};
int a_6[NUM_POINTS] = {1, 1, 1, 1, 1, 3, 3, 3, 3, 3, 4, 4, 4, 4, 5, 9, 11, 12, 12, 14, 14, 14, 15, 15, 19, 19, 20, 21, 21, 31, 31, 33, 33, 36, 36, 39, 39, 40, 42, 42, 44, 46, 48, 48, 49, 49, 50, 52, 54, 61, 61, 62, 62, 66, 67, 70};
point points[NUM_POINTS];

void cleanup(int s) {
    fclose(target_in);
    fclose(target_out);
    close(target_raw[0]); 
    close(target_raw[1]); 
    close(attack_raw[0]); 
    close(attack_raw[1]); 
    if (pid > 0) kill(pid, SIGKILL);
    exit(1); 
}

void assign_points() {
    for (int i = 0; i < NUM_POINTS; i++) {
        mpz_inits(points[i].x, points[i].y, NULL);
    }
    mpz_set_str(points[0].x, "28259279395972023776513774105241928246962498203283306978725161059915300516812", 10); mpz_set_str(points[0].y, "63209961896593677827159582592311321908483099424656281348075589839784323824847", 10);
    mpz_set_str(points[1].x, "87713185297228976821304890513941862211693061851535545840693819255454361634048", 10); mpz_set_str(points[1].y, "112693079826111214039277966073432377400336220628474151196801500581911598124509", 10);
    mpz_set_str(points[2].x, "206883884147126945808549336763852493698012431899018050348556697572236602683", 10); mpz_set_str(points[2].y, "20608134931947835620991899010681971494154276791145956869592094752965415335247", 10);
    mpz_set_str(points[3].x, "69881283504569799488602239712833087975425166784596071774520794672185507702440", 10); mpz_set_str(points[3].y, "42478926601988875279028976856574013051927848516429690233932858856224934471364", 10);
    mpz_set_str(points[4].x, "25775413810489730027531476036637049728872382788445394870248456751344290946088", 10); mpz_set_str(points[4].y, "48098706110172973464517362651969722623725248533356877915476596697642760088579", 10);
    mpz_set_str(points[5].x, "104678110497112089739021755190598720911144497118944825291883337410031374501651", 10); mpz_set_str(points[5].y, "0", 10);
    mpz_set_str(points[6].x, "89160674440956328538893206540265823545209810924936759489615962285452747599555", 10); mpz_set_str(points[6].y, "52836242829875876292581891125276081784043606482480767427606671740391240450713", 10);
    mpz_set_str(points[7].x, "71381269501775968128475011265598269069347980821218846743948246753286064412420", 10); mpz_set_str(points[7].y, "93106089722491605224338586731271529062359787069042949543385151555752345954179", 10);
    mpz_set_str(points[8].x, "30904076697445238773861874582065136691682689019361035376155684137084335642348", 10); mpz_set_str(points[8].y, "44581633413506981437332018259337199045876739282554009841521896356257539543530", 10);
    mpz_set_str(points[9].x, "37740878285059773035328689737568253192782053795734741220535442668741782227005", 10); mpz_set_str(points[9].y, "97859746809226442457938140864810156199654698584313597023826244066108044386181", 10);
    mpz_set_str(points[10].x, "104136813632778771640723729751464035108143385005433100064043059550777778556984", 10); mpz_set_str(points[10].y, "15014177230142224843904041558393363953733994483644983931314086007831689563066", 10);
    mpz_set_str(points[11].x, "36221710188095645195916735943504126562048718788327839336905432475771375088876", 10); mpz_set_str(points[11].y, "65733430588181762227151762173430151752013131127102040334492994886275821618878", 10);
    mpz_set_str(points[12].x, "19266681284548760829403297706358392755309516987335583377397055619851330063169", 10); mpz_set_str(points[12].y, "115492014883061975461992340482394619395522701733330184126317566082592026221943", 10);
    mpz_set_str(points[13].x, "108725273062108112757164265968313783127328954942354440318545455442753789970128", 10); mpz_set_str(points[13].y, "56626446366152483510283860071227638814991915877593437448427667291770046867350", 10);
    mpz_set_str(points[14].x, "51896770152511673981968622706299486704194470668181753013246919989382842739910", 10); mpz_set_str(points[14].y, "44974617826304704518136705750109983576513297829925574154480434246772498479217", 10);
    mpz_set_str(points[15].x, "80399323733805371647278874455416495727665351687995874532963703346580557182215", 10); mpz_set_str(points[15].y, "64221097626823962777722972078298176284771360698147733241577406594190323253525", 10);
    mpz_set_str(points[16].x, "37795557974970371519487312148887192918305960495147418096832791872247505882621", 10); mpz_set_str(points[16].y, "61147296591064249257955580639646489274401929545998690686781250270375381534956", 10);
    mpz_set_str(points[17].x, "31595831993368958708756390443130025217175750116889125802216877195369387670538", 10); mpz_set_str(points[17].y, "113685024074464209570625491562318497579116301699584020533141320468987813018840", 10);
    mpz_set_str(points[18].x, "86777023071443973650759726219306030059744689148080908618061955376713540425038", 10); mpz_set_str(points[18].y, "43280915548009789573678997069200513419682698710705700055526224897913252818446", 10);
    mpz_set_str(points[19].x, "3413459363395996421077657095954449129535482526656543541251186863502954511992", 10); mpz_set_str(points[19].y, "1838520503069831081084618017350900277772667650158943821878116964019848605801", 10);
    mpz_set_str(points[20].x, "14966144267389723782847602649653032427348427111610616793571707357613487810271", 10); mpz_set_str(points[20].y, "114698845801755732114560608350539734785738135357056479089679715896226602077503", 10);
    mpz_set_str(points[21].x, "62269680450948285639937835043830165400537068952885818358499615616184336196576", 10); mpz_set_str(points[21].y, "76238607702193277407378511998289866107205926593740377936268095875301661875169", 10);
    mpz_set_str(points[22].x, "38484100367918503545168415316162136609686705856689256383154622999120828068216", 10); mpz_set_str(points[22].y, "37444630015825408056828258447618085016729225264145246434409494530974797740154", 10);
    mpz_set_str(points[23].x, "27152844424558016935261366635707450150700642167415093024797045732139176489740", 10); mpz_set_str(points[23].y, "6550820316963708270980766282148480279221063353875581691130317914051327688378", 10);
    mpz_set_str(points[24].x, "11558178732251576330294510069979547887342244276702047654030051460396058662497", 10); mpz_set_str(points[24].y, "87254271143199490539665399634971558884490527915076501909711209983947132853337", 10);
    mpz_set_str(points[25].x, "9514346497383556222579619158341776674131364064273695483727358392426157182957", 10); mpz_set_str(points[25].y, "23495205416855217052557520192504178663030120373308667027919135702875839853362", 10);
    mpz_set_str(points[26].x, "12429657496764110525959663766544070467746376152800768399443398493342181975854", 10); mpz_set_str(points[26].y, "69057829560526670847162725836848206568571225594049174692515881748726964004733", 10);
    mpz_set_str(points[27].x, "57918052159968238616619540218021789167037255883234912121083241916392144331885", 10); mpz_set_str(points[27].y, "95646629799794040007199549490698192209142383259456190804730628440879012419866", 10);
    mpz_set_str(points[28].x, "65774881983761717312270456499009503411729572183359173173249925597483488542474", 10); mpz_set_str(points[28].y, "6567335573532975085815797319308921109552197043248793123121966089262835731514", 10);
    mpz_set_str(points[29].x, "56640544195937444035716179134321246089995386945079699305865570199904911353153", 10); mpz_set_str(points[29].y, "7127871820181015976774868561218996588707527000691958085027891777694816487935", 10);
    mpz_set_str(points[30].x, "114478979147039371114757454159184408364550736658297615439777362484515217378996", 10); mpz_set_str(points[30].y, "40706974332247832662962637854620584522597024847435929774538312959890136346180", 10);
    mpz_set_str(points[31].x, "45236375731980838384708777856117825326208567790512075389743893039456417046789", 10); mpz_set_str(points[31].y, "66869404498886028212570476567087765983673963126718071709414865704071173340310", 10);
    mpz_set_str(points[32].x, "82842327826922627380780125680708202131601933000827345113683718307637265277572", 10); mpz_set_str(points[32].y, "106057195468941660838338129388774945902021274298369675276265816364842506064011", 10);
    mpz_set_str(points[33].x, "62649556530269196374231219733504197101362833037237431123508083468348196209569", 10); mpz_set_str(points[33].y, "56072938607500302600356056496116185493916452958743688847820379779198298973504", 10);
    mpz_set_str(points[34].x, "54106689002855714160260697291342690504819711080466227310062599079248225039243", 10); mpz_set_str(points[34].y, "51409669475836465862573970907596273303407533157801814523688108418459478701230", 10);
    mpz_set_str(points[35].x, "66073797683304679417667691212935185320538365482079408635817239012409995092923", 10); mpz_set_str(points[35].y, "75469137334836900112404889116548219362689381013229884628746616324707084763833", 10);
    mpz_set_str(points[36].x, "107479559353094356240185868941494731270545981617575543057669924051052738284946", 10); mpz_set_str(points[36].y, "5053535302272579529892886307877652761565257832805103735722766720968017280618", 10);
    mpz_set_str(points[37].x, "22875956984718106148501378873082845515974032381625665763247246412416716849543", 10); mpz_set_str(points[37].y, "82747000226249230260938204288413325412608915799429555960378802450307589740638", 10);
    mpz_set_str(points[38].x, "101741935224361460818736481701364602153143423360261538046986862667710961317064", 10); mpz_set_str(points[38].y, "51166816763883626239516605216340933938215591492359628940860736169918943807016", 10);
    mpz_set_str(points[39].x, "81243841971761400417520053751454753952646603900894010386511265402835565126956", 10); mpz_set_str(points[39].y, "71916324325448558471871531800648096257229970008419525372690167245166719704673", 10);
    mpz_set_str(points[40].x, "14530069933754903044065080678080909292421892643197985993724529598946710247884", 10); mpz_set_str(points[40].y, "104967125356983797731729931162496772592968446192098666170922041523261942437949", 10);
    mpz_set_str(points[41].x, "109365146173285488961422160657100024298400133975584332652289706557320455640695", 10); mpz_set_str(points[41].y, "1681362622036232171551955708886567920954331999837914822941411063159049945286", 10);
    mpz_set_str(points[42].x, "60113342969066112042728868630551622159382497455324446140472695565125439596476", 10); mpz_set_str(points[42].y, "113835658428893081236046863686582559469215336749105783467952435889581050817175", 10);
    mpz_set_str(points[43].x, "14534927461442511841092204729595321244867670049984851301893759908352609392202", 10); mpz_set_str(points[43].y, "111672596123872250255070651240754430001908171298430151412072785978280608663781", 10);
    mpz_set_str(points[44].x, "73739620478539798645692379438172195564505382932777326557855976777314934012534", 10); mpz_set_str(points[44].y, "8136534632098467553867008588333282245623879581627291613546269869920100743493", 10);
    mpz_set_str(points[45].x, "66480192396435807908450506164891875571424233689385633091814694996877308359083", 10); mpz_set_str(points[45].y, "106477623710624342085495906746533578010419741196915798938814730985636384997264", 10);
    mpz_set_str(points[46].x, "114261429633200676984754066987659989424575407457895825332943954091332137942439", 10); mpz_set_str(points[46].y, "99784514485859767620619258798465892679169539345584122872801831405189828370374", 10);
    mpz_set_str(points[47].x, "89849957831485468518188002649090924578272678499930957340265801798498938999535", 10); mpz_set_str(points[47].y, "60128298300142570699040832498705019123085745379319110474116794324409722507617", 10);
    mpz_set_str(points[48].x, "100035202201497059788717356733161857692336124543187879985250419877289006495598", 10); mpz_set_str(points[48].y, "58662639642709808963394100371881745234544327684020323791191706095988441978973", 10);
    mpz_set_str(points[49].x, "3006993746500054270864490793354204820378686851267711452631855113996397637344", 10); mpz_set_str(points[49].y, "19104152074430271166352898484162412225304710915835525716317621541170459916437", 10);
    mpz_set_str(points[50].x, "66675270946268429991402502408882298568497888580573933991459276916417897284987", 10); mpz_set_str(points[50].y, "4653644998626377300101659475260420635808086153104183380445564929137224619508", 10);
    mpz_set_str(points[51].x, "3668295410264019769338410719147355163427046739760489055869254190276501532950", 10); mpz_set_str(points[51].y, "50022563339179962012608233399264439744653107131866157321338881858972798754874", 10);
    mpz_set_str(points[52].x, "82578358241576305469964324979533196033717918953622955882915123361600262953139", 10); mpz_set_str(points[52].y, "93184764761902659966478835239970325091114361438499700002930213279923718723068", 10);
    mpz_set_str(points[53].x, "55030172201210812898824400928176169719946292226811843923643909008776221001870", 10); mpz_set_str(points[53].y, "85462144257959636305735004709717131325050447794097798269232341333942346238235", 10);
    mpz_set_str(points[54].x, "90983947348833835290319902386811656319683906006528590092753141504876934977810", 10); mpz_set_str(points[54].y, "27942637801340794506227589880374426499150846947109720024336890767946122522736", 10);
    mpz_set_str(points[55].x, "16014936581903786455562763973366341013537912920637973157563629192232590278532", 10); mpz_set_str(points[55].y, "66794201377270027931110545910945504492795351393119969238070252259704554927411", 10);
}

void interact(point *p, point *q, unsigned char *interactions) {
    interactions++;

    gmp_fprintf(target_in, "%ZX\n", p->x);
    gmp_fprintf(target_in, "%ZX\n", p->y);
    fflush(target_in);

    gmp_fscanf(target_out, "%ZX\n", &(q->x));
    gmp_fscanf(target_out, "%ZX", &(q->y));
}

void get_multiplied_points(point multiplied_points[NUM_POINTS], unsigned char* interactions) {
    for (int i = 0; i < NUM_POINTS; i++) {
        mpz_inits(multiplied_points[i].x, multiplied_points[i].y, NULL);
        interact(&points[i], &multiplied_points[i], interactions);
    }
}

void add_point(point *p, point *q, mpz_t *a_4, mpz_t* base) {
    mpz_t dydx, temp;
    mpz_inits(dydx, temp, NULL);

    if (mpz_cmp(p->x, q->x) == 0 && mpz_cmp(p->y, q->y) == 0) {
        mpz_mul(dydx, p->x, p->x);
        mpz_mul_ui(dydx, dydx, 3);
        mpz_add(dydx, dydx, *a_4);
        mpz_mul_ui(temp, p->y, 2);
        mpz_invert(temp, temp, *base);
        mpz_mul(dydx, dydx, temp);
    }
    else {
        mpz_sub(dydx, q->y, p->y);
        mpz_sub(temp, q->x, p->x);
        mpz_invert(temp, temp, *base);
        mpz_mul(dydx, dydx, temp);
    }

    mpz_mul(temp, dydx, dydx);
    mpz_sub(temp, temp, p->x);
    mpz_sub(temp, temp, q->x);
    mpz_mod(q->x, temp, *base);

    mpz_sub(temp, p->x, q->x);
    mpz_mul(temp, dydx, temp);
    mpz_sub(temp, temp, p->y);
    mpz_mod(q->y, temp, *base);

    mpz_clears(dydx, temp, NULL);
}

int calc_remainder(point *original_point, point *multiplied_point, mpz_t *a_4, mpz_t *base) {
    int i = 1;

    point temp;
    mpz_inits(temp.x, temp.y, NULL);
    mpz_set(temp.x, original_point->x);
    mpz_set(temp.y, original_point->y);

    while (mpz_cmp(temp.x, multiplied_point->x) || mpz_cmp(temp.y, multiplied_point->y)) {
        add_point(original_point, &temp, a_4, base);
        i++;
    }
    
    mpz_clears(temp.x, temp.y, NULL);

    return i;
}

void calc_remainders(int remainders[NUM_POINTS], point points[NUM_POINTS], point multiplied_points[NUM_POINTS]) {
    mpz_t a_4, base;
    mpz_inits(a_4, base, NULL);
    mpz_set_str(a_4, "115792089210356248762697446949407573530086143415290314195533631308867097853948", 10);
    mpz_set_str(base, "115792089210356248762697446949407573530086143415290314195533631308867097853951", 10);

    for (int i = 0; i < NUM_POINTS; i++) {
        remainders[i] = calc_remainder(&points[i], &multiplied_points[i], &a_4, &base);
        printf("%d\n", remainders[i]);
    }

    mpz_clears(a_4, base, NULL);
}

void attack() {
    assign_points();
    point multiplied_points[NUM_POINTS];
    int remainders[NUM_POINTS];
    unsigned char interactions;
    get_multiplied_points(multiplied_points, &interactions);
    calc_remainders(remainders, points, multiplied_points);
}

int main(int argc, char* argv[]) {
    signal(SIGINT, &cleanup);

    if (pipe(target_raw) == -1) abort();
    if (pipe(attack_raw) == -1) abort();

    pid = fork();
    if (pid > 0) {
        if ((target_out = fdopen(attack_raw[0], "r")) == NULL) abort();
        if ((target_in = fdopen(target_raw[1], "w")) == NULL) abort();
        attack();
    }
    else if (pid == 0) {
        close(STDOUT_FILENO);
        if (dup2(attack_raw[1], STDOUT_FILENO) == -1) abort();
        close(STDIN_FILENO);
        if (dup2(target_raw[0], STDIN_FILENO) == -1) abort();
        execl(argv[1], argv[0], NULL);
    }
    else if (pid < 0) {
        abort();
    }

    cleanup(SIGINT);
    return 0;
}